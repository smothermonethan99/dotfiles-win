# Christian Lempa Windows Dotfiles Setup Script
# Run as Administrator

#Requires -RunAsAdministrator

$ErrorActionPreference = "Continue"

Write-Host "=== Christian Lempa Windows Dotfiles Setup ===" -ForegroundColor Cyan
Write-Host ""

# Function to check if winget is installed
function Test-WingetInstalled {
    try {
        winget --version | Out-Null
        return $true
    }
    catch {
        return $false
    }
}

# Install winget if not present
if (-not (Test-WingetInstalled)) {
    Write-Host "Installing winget..." -ForegroundColor Yellow
    $progressPreference = 'silentlyContinue'
    Invoke-WebRequest -Uri https://aka.ms/getwinget -OutFile "$env:TEMP\Microsoft.DesktopAppInstaller_8wekyb3d8bbwe.msixbundle"
    Add-AppxPackage "$env:TEMP\Microsoft.DesktopAppInstaller_8wekyb3d8bbwe.msixbundle"
}

Write-Host "Installing applications via winget..." -ForegroundColor Green

# Essential tools from Christian Lempa's cheat-sheets
$apps = @(
    "Git.Git",
    "Microsoft.PowerShell",
    "Microsoft.WindowsTerminal",
    "Microsoft.VisualStudioCode",
    "Docker.DockerDesktop",
    "Kubernetes.kubectl",
    "Helm.Helm",
    "HashiCorp.Terraform",
    "HashiCorp.Vagrant",
    "Python.Python.3.12",
    "OpenJS.NodeJS",
    "Neovim.Neovim",
    "vim.vim",
    "Obsidian.Obsidian",
    "7zip.7zip",
    "Mozilla.Firefox",
    "Google.Chrome"
)

foreach ($app in $apps) {
    Write-Host "Installing $app..." -ForegroundColor Yellow
    winget install --id=$app -e --silent --accept-package-agreements --accept-source-agreements
}

# Install Hack Nerd Font
Write-Host "Installing Hack Nerd Font..." -ForegroundColor Green
$fontUrl = "https://github.com/ryanoasis/nerd-fonts/releases/latest/download/Hack.zip"
$fontZip = "$env:TEMP\Hack.zip"
$fontExtract = "$env:TEMP\HackFont"

Invoke-WebRequest -Uri $fontUrl -OutFile $fontZip
Expand-Archive -Path $fontZip -DestinationPath $fontExtract -Force

$fonts = (New-Object -ComObject Shell.Application).Namespace(0x14)
Get-ChildItem -Path $fontExtract -Filter "*.ttf" | ForEach-Object {
    $fonts.CopyHere($_.FullName)
}

Remove-Item $fontZip, $fontExtract -Recurse -Force

# Download wallpaper
Write-Host "Downloading wallpaper..." -ForegroundColor Green
$wallpaperPath = "$env:USERPROFILE\Pictures\mr-robot-wallpaper.png"
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/ChristianLempa/hackbox/main/src/assets/mr-robot-wallpaper.png" -OutFile $wallpaperPath

# Set wallpaper
Add-Type -TypeDefinition @"
using System;
using System.Runtime.InteropServices;
public class Wallpaper {
    [DllImport("user32.dll", CharSet=CharSet.Auto)]
    public static extern int SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);
}
"@
[Wallpaper]::SystemParametersInfo(0x0014, 0, $wallpaperPath, 0x0001 -bor 0x0002)

# Set Windows to Dark Mode
Write-Host "Setting Windows to Dark Mode..." -ForegroundColor Green
Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize" -Name "AppsUseLightTheme" -Value 0
Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize" -Name "SystemUsesLightTheme" -Value 0

# Taskbar settings (Christian Lempa style - small icons, aligned left on Windows 11)
Write-Host "Configuring taskbar..." -ForegroundColor Green
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Name "TaskbarSmallIcons" -Value 1 -ErrorAction SilentlyContinue
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Name "TaskbarAl" -Value 0 -ErrorAction SilentlyContinue

# Configure Windows Terminal with xcad color scheme
Write-Host "Configuring Windows Terminal with xcad theme..." -ForegroundColor Green
$terminalSettingsPath = "$env:LOCALAPPDATA\Packages\Microsoft.WindowsTerminal_8wekyb3d8bbwe\LocalState\settings.json"

if (Test-Path $terminalSettingsPath) {
    $settings = Get-Content $terminalSettingsPath -Raw | ConvertFrom-Json
    
    # Add xcad color scheme
    $xcadScheme = @{
        name = "xcad"
        background = "#1A1A1A"
        black = "#121212"
        blue = "#2B4FFF"
        brightBlack = "#666666"
        brightBlue = "#5C78FF"
        brightCyan = "#5AC8FF"
        brightGreen = "#905AFF"
        brightPurple = "#5EA2FF"
        brightRed = "#BA5AFF"
        brightWhite = "#FFFFFF"
        brightYellow = "#685AFF"
        cursorColor = "#FFFFFF"
        cyan = "#28B9FF"
        foreground = "#F1F1F1"
        green = "#7129FF"
        purple = "#2883FF"
        red = "#A52AFF"
        selectionBackground = "#FFFFFF"
        white = "#F1F1F1"
        yellow = "#3D2AFF"
    }
    
    # Remove existing xcad scheme if present
    $settings.schemes = @($settings.schemes | Where-Object { $_.name -ne "xcad" })
    $settings.schemes += $xcadScheme
    
    # Update defaults
    $settings.profiles.defaults = @{
        colorScheme = "xcad"
        cursorShape = "filledBox"
        font = @{
            face = "Hack Nerd Font"
            size = 14
        }
        historySize = 12000
        intenseTextStyle = "bright"
        opacity = 95
        padding = "8"
        scrollbarState = "visible"
        useAcrylic = $false
    }
    
    $settings | ConvertTo-Json -Depth 10 | Set-Content $terminalSettingsPath
    Write-Host "Windows Terminal configured successfully!" -ForegroundColor Green
}

# Install WSL
Write-Host "Installing WSL..." -ForegroundColor Green
wsl --install --no-distribution

# Install WSL distributions
Write-Host "Installing WSL distributions..." -ForegroundColor Green
wsl --install -d Ubuntu-22.04
wsl --install -d kali-linux
wsl --install -d Arch

# Create starship config
Write-Host "Creating Starship configuration..." -ForegroundColor Green
$starshipConfig = @'
add_newline = false
command_timeout = 1000
format = """$os$username$hostname$kubernetes$directory$git_branch$git_status"""

[character]
success_symbol = ''
error_symbol = ''

[os]
format = '[$symbol](bold white) '   
disabled = false

[os.symbols]
Windows = ''
Arch = 'ó°£‡'
Ubuntu = ''
Macos = 'ó°€µ'

[username]
style_user = 'white bold'
style_root = 'black bold'
format = '[$user]($style) '
disabled = false
show_always = true

[hostname]
ssh_only = false
format = 'on [$hostname](bold yellow) '
disabled = false

[directory]
truncation_length = 1
truncation_symbol = 'â€¦/'
home_symbol = 'ó°‹œ ~'
read_only_style = '197'
read_only = '  '
format = 'at [$path]($style)[$read_only]($read_only_style) '

[git_branch]
symbol = ' '
format = 'via [$symbol$branch]($style)'
truncation_symbol = 'â€¦/'
style = 'bold green'

[git_status]
format = '[$all_status$ahead_behind]($style) '
style = 'bold green'
conflicted = 'ðŸ³'
up_to_date = ''
untracked = ' '
ahead = 'â‡¡${count}'
diverged = 'â‡•â‡¡${ahead_count}â‡£${behind_count}'
behind = 'â‡£${count}'
stashed = ' '
modified = ' '
staged = '[++\($count\)](green)'
renamed = 'è¥ '
deleted = ' '

[terraform]
format = "via [ terraform $version]($style) å£Ÿ [$workspace]($style) "

[vagrant]
format = "via [ vagrant $version]($style) "

[docker_context]
format = "via [ $context](bold blue) "

[helm]
format = "via [ $version](bold purple) "

[python]
symbol = " "
python_binary = "python3"

[nodejs]
format = "via [ $version](bold green) "
disabled = true

[ruby]
format = "via [ $version]($style) "

[kubernetes]
format = 'via [ï´± $context\($namespace\)](bold purple) '
disabled = false

[kubernetes.context_aliases]
"do-fra1-prod-k8s-clcreative" = " lgcy-1"
"infra-home-kube-prod-1" = " prod-1"
"infra-home-kube-prod-2" = " prod-2"
"infra-cloud-kube-prod-1" = " prod-1"
"infra-cloud-kube-test-1" = " test-1"
'@

# Save starship config for PowerShell
$configPath = "$env:USERPROFILE\.config"
if (-not (Test-Path $configPath)) {
    New-Item -ItemType Directory -Path $configPath -Force | Out-Null
}
$starshipConfig | Set-Content "$configPath\starship.toml" -Encoding UTF8

# Install Starship for PowerShell
Write-Host "Installing Starship..." -ForegroundColor Green
winget install --id Starship.Starship -e --silent

# Add Starship to PowerShell profile
$profileContent = @'
Invoke-Expression (&starship init powershell)
'@

if (-not (Test-Path $PROFILE)) {
    New-Item -Path $PROFILE -ItemType File -Force | Out-Null
}

if (-not (Select-String -Path $PROFILE -Pattern "starship init" -Quiet)) {
    Add-Content -Path $PROFILE -Value $profileContent
}

# Configure Starship for WSL distributions
Write-Host "Configuring Starship for WSL distributions..." -ForegroundColor Green

$wslSetupScript = @'
#!/bin/bash
# Install Starship
curl -sS https://starship.rs/install.sh | sh -s -- -y

# Create config directory
mkdir -p ~/.config

# Create starship.toml
cat > ~/.config/starship.toml << 'STARSHIP_EOF'
add_newline = false
command_timeout = 1000
format = """$os$username$hostname$kubernetes$directory$git_branch$git_status"""

[character]
success_symbol = ''
error_symbol = ''

[os]
format = '[$symbol](bold white) '   
disabled = false

[os.symbols]
Windows = ''
Arch = 'ó°£‡'
Ubuntu = ''
Macos = 'ó°€µ'

[username]
style_user = 'white bold'
style_root = 'black bold'
format = '[$user]($style) '
disabled = false
show_always = true

[hostname]
ssh_only = false
format = 'on [$hostname](bold yellow) '
disabled = false

[directory]
truncation_length = 1
truncation_symbol = 'â€¦/'
home_symbol = 'ó°‹œ ~'
read_only_style = '197'
read_only = '  '
format = 'at [$path]($style)[$read_only]($read_only_style) '

[git_branch]
symbol = ' '
format = 'via [$symbol$branch]($style)'
truncation_symbol = 'â€¦/'
style = 'bold green'

[git_status]
format = '[$all_status$ahead_behind]($style) '
style = 'bold green'
conflicted = 'ðŸ³'
up_to_date = ''
untracked = ' '
ahead = 'â‡¡${count}'
diverged = 'â‡•â‡¡${ahead_count}â‡£${behind_count}'
behind = 'â‡£${count}'
stashed = ' '
modified = ' '
staged = '[++\($count\)](green)'
renamed = 'è¥ '
deleted = ' '

[terraform]
format = "via [ terraform $version]($style) å£Ÿ [$workspace]($style) "

[vagrant]
format = "via [ vagrant $version]($style) "

[docker_context]
format = "via [ $context](bold blue) "

[helm]
format = "via [ $version](bold purple) "

[python]
symbol = " "
python_binary = "python3"

[nodejs]
format = "via [ $version](bold green) "
disabled = true

[ruby]
format = "via [ $version]($style) "

[kubernetes]
format = 'via [ï´± $context\($namespace\)](bold purple) '
disabled = false

[kubernetes.context_aliases]
"do-fra1-prod-k8s-clcreative" = " lgcy-1"
"infra-home-kube-prod-1" = " prod-1"
"infra-home-kube-prod-2" = " prod-2"
"infra-cloud-kube-prod-1" = " prod-1"
"infra-cloud-kube-test-1" = " test-1"
STARSHIP_EOF

# Add to bashrc
if ! grep -q "starship init bash" ~/.bashrc; then
    echo 'eval "$(starship init bash)"' >> ~/.bashrc
fi

# Add to zshrc if it exists
if [ -f ~/.zshrc ]; then
    if ! grep -q "starship init zsh" ~/.zshrc; then
        echo 'eval "$(starship init zsh)"' >> ~/.zshrc
    fi
fi

echo "Starship configured successfully!"
'@

$wslSetupScript | Set-Content "$env:TEMP\wsl-setup.sh" -Encoding UTF8

# Apply to each WSL distribution
$distros = @("Ubuntu-22.04", "kali-linux", "Arch")
foreach ($distro in $distros) {
    Write-Host "Configuring $distro..." -ForegroundColor Yellow
    wsl -d $distro -e bash -c "cat > /tmp/wsl-setup.sh" < "$env:TEMP\wsl-setup.sh"
    wsl -d $distro -e bash /tmp/wsl-setup.sh
}

Write-Host ""
Write-Host "=== Setup Complete! ===" -ForegroundColor Green
Write-Host ""
Write-Host "Please restart your computer to apply all changes." -ForegroundColor Yellow
Write-Host "After restart, you may need to complete WSL distribution setup manually." -ForegroundColor Yellow
Write-Host ""
Write-Host "Configured:" -ForegroundColor Cyan
Write-Host "  - Windows Terminal with xcad theme" -ForegroundColor White
Write-Host "  - Hack Nerd Font installed" -ForegroundColor White
Write-Host "  - Dark mode enabled" -ForegroundColor White
Write-Host "  - Wallpaper set" -ForegroundColor White
Write-Host "  - WSL with Ubuntu 22.04, Kali, and Arch" -ForegroundColor White
Write-Host "  - Starship prompt for PowerShell and all WSL distros" -ForegroundColor White
Write-Host "  - Christian Lempa's essential tools" -ForegroundColor White