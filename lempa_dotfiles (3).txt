# Christian Lempa Windows Dotfiles Setup Script
# Run as Administrator

#Requires -RunAsAdministrator

$ErrorActionPreference = "Continue"

Write-Host "=== Christian Lempa Windows Dotfiles Setup ===" -ForegroundColor Cyan
Write-Host ""

# Function to check if winget is installed
function Test-WingetInstalled {
    try {
        winget --version | Out-Null
        return $true
    }
    catch {
        return $false
    }
}

# Install winget if not present
if (-not (Test-WingetInstalled)) {
    Write-Host "Installing winget..." -ForegroundColor Yellow
    $progressPreference = 'silentlyContinue'
    Invoke-WebRequest -Uri https://aka.ms/getwinget -OutFile "$env:TEMP\Microsoft.DesktopAppInstaller_8wekyb3d8bbwe.msixbundle"
    Add-AppxPackage "$env:TEMP\Microsoft.DesktopAppInstaller_8wekyb3d8bbwe.msixbundle"
}

Write-Host "Installing applications via winget..." -ForegroundColor Green

# Essential tools from Christian Lempa's cheat-sheets
$apps = @(
    "Git.Git",
    "Microsoft.PowerShell",
    "Microsoft.WindowsTerminal",
    "Microsoft.VisualStudioCode",
    "Docker.DockerDesktop",
    "Kubernetes.kubectl",
    "Helm.Helm",
    "HashiCorp.Terraform",
    "HashiCorp.Vagrant",
    "Python.Python.3.12",
    "OpenJS.NodeJS",
    "Neovim.Neovim",
    "vim.vim",
    "Obsidian.Obsidian",
    "7zip.7zip",
    "Mozilla.Firefox",
    "Google.Chrome"
)

foreach ($app in $apps) {
    Write-Host "Installing $app..." -ForegroundColor Yellow
    winget install --id=$app -e --source winget --silent --accept-package-agreements --accept-source-agreements
}

# Install Hack Nerd Font
Write-Host "Installing Hack Nerd Font..." -ForegroundColor Green
$fontUrl = "https://github.com/ryanoasis/nerd-fonts/releases/latest/download/Hack.zip"
$fontZip = "$env:TEMP\Hack.zip"
$fontExtract = "$env:TEMP\HackFont"

Invoke-WebRequest -Uri $fontUrl -OutFile $fontZip
Expand-Archive -Path $fontZip -DestinationPath $fontExtract -Force

$fonts = (New-Object -ComObject Shell.Application).Namespace(0x14)
Get-ChildItem -Path $fontExtract -Filter "*.ttf" | ForEach-Object {
    $fonts.CopyHere($_.FullName)
}

Remove-Item $fontZip, $fontExtract -Recurse -Force

# Download wallpaper
Write-Host "Downloading wallpaper..." -ForegroundColor Green
$wallpaperPath = "$env:USERPROFILE\Pictures\mr-robot-wallpaper.png"
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/ChristianLempa/hackbox/main/src/assets/mr-robot-wallpaper.png" -OutFile $wallpaperPath

# Set wallpaper
Add-Type -TypeDefinition @"
using System;
using System.Runtime.InteropServices;
public class Wallpaper {
    [DllImport("user32.dll", CharSet=CharSet.Auto)]
    public static extern int SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);
}
"@
[Wallpaper]::SystemParametersInfo(0x0014, 0, $wallpaperPath, 0x0001 -bor 0x0002)

# Set Windows to Dark Mode
Write-Host "Setting Windows to Dark Mode..." -ForegroundColor Green
Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize" -Name "AppsUseLightTheme" -Value 0
Set-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize" -Name "SystemUsesLightTheme" -Value 0

# Taskbar settings (Christian Lempa style - compact, clean taskbar)
Write-Host "Configuring taskbar..." -ForegroundColor Green
# Hide search box
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Search" -Name "SearchboxTaskbarMode" -Value 0 -ErrorAction SilentlyContinue
# Hide task view button
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Name "ShowTaskViewButton" -Value 0 -ErrorAction SilentlyContinue
# Small taskbar icons (Windows 10)
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Name "TaskbarSmallIcons" -Value 1 -ErrorAction SilentlyContinue
# Left align taskbar (Windows 11)
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Name "TaskbarAl" -Value 0 -ErrorAction SilentlyContinue
# Hide Cortana button
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced" -Name "ShowCortanaButton" -Value 0 -ErrorAction SilentlyContinue
# Auto-hide taskbar
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\StuckRects3" -Name "Settings" -Value ([byte[]](0x30,0x00,0x00,0x00,0xfe,0xff,0xff,0xff,0x02,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x3e,0x00,0x00,0x00,0x2e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00)) -ErrorAction SilentlyContinue

# Configure Windows Terminal with xcad color scheme
Write-Host "Configuring Windows Terminal with xcad theme..." -ForegroundColor Green
$terminalSettingsPath = "$env:LOCALAPPDATA\Packages\Microsoft.WindowsTerminal_8wekyb3d8bbwe\LocalState\settings.json"

if (Test-Path $terminalSettingsPath) {
    $settings = Get-Content $terminalSettingsPath -Raw | ConvertFrom-Json
    
    # Add xcad color scheme
    $xcadScheme = @{
        name = "xcad"
        background = "#1A1A1A"
        black = "#121212"
        blue = "#2B4FFF"
        brightBlack = "#666666"
        brightBlue = "#5C78FF"
        brightCyan = "#5AC8FF"
        brightGreen = "#905AFF"
        brightPurple = "#5EA2FF"
        brightRed = "#BA5AFF"
        brightWhite = "#FFFFFF"
        brightYellow = "#685AFF"
        cursorColor = "#FFFFFF"
        cyan = "#28B9FF"
        foreground = "#F1F1F1"
        green = "#7129FF"
        purple = "#2883FF"
        red = "#A52AFF"
        selectionBackground = "#FFFFFF"
        white = "#F1F1F1"
        yellow = "#3D2AFF"
    }
    
    # Remove existing xcad scheme if present
    $settings.schemes = @($settings.schemes | Where-Object { $_.name -ne "xcad" })
    $settings.schemes += $xcadScheme
    
    # Update defaults
    $settings.profiles.defaults = @{
        colorScheme = "xcad"
        cursorShape = "filledBox"
        font = @{
            face = "Hack Nerd Font"
            size = 14
        }
        historySize = 12000
        intenseTextStyle = "bright"
        opacity = 95
        padding = "8"
        scrollbarState = "visible"
        useAcrylic = $false
    }
    
    $settings | ConvertTo-Json -Depth 10 | Set-Content $terminalSettingsPath
    Write-Host "Windows Terminal configured successfully!" -ForegroundColor Green
}

# Install WSL2
Write-Host "Installing WSL2..." -ForegroundColor Green
wsl --install --no-distribution

Write-Host ""
Write-Host "Installing WSL distributions (Ubuntu, Kali, Arch)..." -ForegroundColor Green
Write-Host "Using --no-launch to prevent automatic startup during installation." -ForegroundColor Yellow
Write-Host ""

# Install distributions without launching them
wsl --install Ubuntu-22.04 --no-launch
wsl --install kali-linux --no-launch
wsl --install arch-linux --no-launch

Write-Host ""
Write-Host "âœ“ WSL distributions installed successfully!" -ForegroundColor Green
Write-Host ""

Write-Host ""
Write-Host "Creating post-install configuration..." -ForegroundColor Green

# Create a simple one-time setup script for each distro
$simpleSetupScript = @'
#!/bin/bash
# One-time Starship setup

MARKER="$HOME/.starship_configured"

if [ -f "$MARKER" ]; then
    exit 0
fi

echo ""
echo "========================================="
echo "  Installing Starship Prompt..."
echo "========================================="
echo ""

# Install Starship
curl -sS https://starship.rs/install.sh | sh -s -- -y

# Create config directory
mkdir -p ~/.config

# Create starship config
cat > ~/.config/starship.toml << 'EOF'
add_newline = false
command_timeout = 1000
format = """$os$username$hostname$kubernetes$directory$git_branch$git_status"""

[character]
success_symbol = ''
error_symbol = ''

[os]
format = '[$symbol](bold white) '   
disabled = false

[os.symbols]
Windows = ''
Arch = 'ó°£‡'
Ubuntu = ''
Macos = 'ó°€µ'

[username]
style_user = 'white bold'
style_root = 'black bold'
format = '[$user]($style) '
disabled = false
show_always = true

[hostname]
ssh_only = false
format = 'on [$hostname](bold yellow) '
disabled = false

[directory]
truncation_length = 1
truncation_symbol = 'â€¦/'
home_symbol = 'ó°‹œ ~'
read_only_style = '197'
read_only = '  '
format = 'at [$path]($style)[$read_only]($read_only_style) '

[git_branch]
symbol = ' '
format = 'via [$symbol$branch]($style)'
truncation_symbol = 'â€¦/'
style = 'bold green'

[git_status]
format = '[$all_status$ahead_behind]($style) '
style = 'bold green'
conflicted = 'ðŸ³'
up_to_date = ''
untracked = ' '
ahead = 'â‡¡${count}'
diverged = 'â‡•â‡¡${ahead_count}â‡£${behind_count}'
behind = 'â‡£${count}'
stashed = ' '
modified = ' '
staged = '[++\($count\)](green)'
renamed = 'è¥ '
deleted = ' '

[terraform]
format = "via [ terraform $version]($style) å£Ÿ [$workspace]($style) "

[vagrant]
format = "via [ vagrant $version]($style) "

[docker_context]
format = "via [ $context](bold blue) "

[helm]
format = "via [ $version](bold purple) "

[python]
symbol = " "
python_binary = "python3"

[nodejs]
format = "via [ $version](bold green) "
disabled = true

[ruby]
format = "via [ $version]($style) "

[kubernetes]
format = 'via [ï´± $context\($namespace\)](bold purple) '
disabled = false

[kubernetes.context_aliases]
"do-fra1-prod-k8s-clcreative" = " lgcy-1"
"infra-home-kube-prod-1" = " prod-1"
"infra-home-kube-prod-2" = " prod-2"
"infra-cloud-kube-prod-1" = " prod-1"
"infra-cloud-kube-test-1" = " test-1"
EOF

# Add to bashrc if not already there
if ! grep -q 'eval "$(starship init bash)"' ~/.bashrc 2>/dev/null; then
    echo '' >> ~/.bashrc
    echo '# Starship prompt' >> ~/.bashrc
    echo 'eval "$(starship init bash)"' >> ~/.bashrc
fi

# Create marker file
touch "$MARKER"

echo ""
echo "âœ“ Starship installed and configured!"
echo ""
echo "Reloading shell configuration..."
source ~/.bashrc

echo ""
echo "Done! Your prompt should now be active."
echo ""
'@

# Save setup script
$setupScriptPath = "$env:USERPROFILE\Desktop\wsl-setup-starship.sh"
$simpleSetupScript | Set-Content $setupScriptPath -Encoding UTF8

Write-Host "Starship setup script saved to your Desktop!" -ForegroundColor Green
Write-Host ""

# Create starship config
Write-Host "Creating Starship configuration..." -ForegroundColor Green
$starshipConfig = @'
add_newline = false
command_timeout = 1000
format = """$os$username$hostname$kubernetes$directory$git_branch$git_status"""

[character]
success_symbol = ''
error_symbol = ''

[os]
format = '[$symbol](bold white) '   
disabled = false

[os.symbols]
Windows = ''
Arch = 'ó°£‡'
Ubuntu = ''
Macos = 'ó°€µ'

[username]
style_user = 'white bold'
style_root = 'black bold'
format = '[$user]($style) '
disabled = false
show_always = true

[hostname]
ssh_only = false
format = 'on [$hostname](bold yellow) '
disabled = false

[directory]
truncation_length = 1
truncation_symbol = 'â€¦/'
home_symbol = 'ó°‹œ ~'
read_only_style = '197'
read_only = '  '
format = 'at [$path]($style)[$read_only]($read_only_style) '

[git_branch]
symbol = ' '
format = 'via [$symbol$branch]($style)'
truncation_symbol = 'â€¦/'
style = 'bold green'

[git_status]
format = '[$all_status$ahead_behind]($style) '
style = 'bold green'
conflicted = 'ðŸ³'
up_to_date = ''
untracked = ' '
ahead = 'â‡¡${count}'
diverged = 'â‡•â‡¡${ahead_count}â‡£${behind_count}'
behind = 'â‡£${count}'
stashed = ' '
modified = ' '
staged = '[++\($count\)](green)'
renamed = 'è¥ '
deleted = ' '

[terraform]
format = "via [ terraform $version]($style) å£Ÿ [$workspace]($style) "

[vagrant]
format = "via [ vagrant $version]($style) "

[docker_context]
format = "via [ $context](bold blue) "

[helm]
format = "via [ $version](bold purple) "

[python]
symbol = " "
python_binary = "python3"

[nodejs]
format = "via [ $version](bold green) "
disabled = true

[ruby]
format = "via [ $version]($style) "

[kubernetes]
format = 'via [ï´± $context\($namespace\)](bold purple) '
disabled = false

[kubernetes.context_aliases]
"do-fra1-prod-k8s-clcreative" = " lgcy-1"
"infra-home-kube-prod-1" = " prod-1"
"infra-home-kube-prod-2" = " prod-2"
"infra-cloud-kube-prod-1" = " prod-1"
"infra-cloud-kube-test-1" = " test-1"
'@

# Save starship config for PowerShell
$configPath = "$env:USERPROFILE\.config"
if (-not (Test-Path $configPath)) {
    New-Item -ItemType Directory -Path $configPath -Force | Out-Null
}
$starshipConfig | Set-Content "$configPath\starship.toml" -Encoding UTF8

# Install Starship for PowerShell
Write-Host "Installing Starship..." -ForegroundColor Green
winget install --id Starship.Starship -e --source winget --silent --accept-package-agreements --accept-source-agreements

# Add Starship to PowerShell profile
$profileContent = @'
Invoke-Expression (&starship init powershell)
'@

if (-not (Test-Path $PROFILE)) {
    New-Item -Path $PROFILE -ItemType File -Force | Out-Null
}

if (-not (Select-String -Path $PROFILE -Pattern "starship init" -Quiet)) {
    Add-Content -Path $PROFILE -Value $profileContent
}

# Configure Starship for WSL distributions
Write-Host "Configuring Starship for WSL distributions..." -ForegroundColor Green

$wslSetupScript = @'
#!/bin/bash
echo "Installing Starship..."
curl -sS https://starship.rs/install.sh | sh -s -- -y

echo "Creating config directory..."
mkdir -p ~/.config
touch ~/.config/starship.toml

echo "Creating starship configuration..."
cat > ~/.config/starship.toml << 'STARSHIP_EOF'
add_newline = false
command_timeout = 1000
format = """$os$username$hostname$kubernetes$directory$git_branch$git_status"""

[character]
success_symbol = ''
error_symbol = ''

[os]
format = '[$symbol](bold white) '   
disabled = false

[os.symbols]
Windows = ''
Arch = 'ó°£‡'
Ubuntu = ''
Macos = 'ó°€µ'

[username]
style_user = 'white bold'
style_root = 'black bold'
format = '[$user]($style) '
disabled = false
show_always = true

[hostname]
ssh_only = false
format = 'on [$hostname](bold yellow) '
disabled = false

[directory]
truncation_length = 1
truncation_symbol = 'â€¦/'
home_symbol = 'ó°‹œ ~'
read_only_style = '197'
read_only = '  '
format = 'at [$path]($style)[$read_only]($read_only_style) '

[git_branch]
symbol = ' '
format = 'via [$symbol$branch]($style)'
truncation_symbol = 'â€¦/'
style = 'bold green'

[git_status]
format = '[$all_status$ahead_behind]($style) '
style = 'bold green'
conflicted = 'ðŸ³'
up_to_date = ''
untracked = ' '
ahead = 'â‡¡${count}'
diverged = 'â‡•â‡¡${ahead_count}â‡£${behind_count}'
behind = 'â‡£${count}'
stashed = ' '
modified = ' '
staged = '[++\($count\)](green)'
renamed = 'è¥ '
deleted = ' '

[terraform]
format = "via [ terraform $version]($style) å£Ÿ [$workspace]($style) "

[vagrant]
format = "via [ vagrant $version]($style) "

[docker_context]
format = "via [ $context](bold blue) "

[helm]
format = "via [ $version](bold purple) "

[python]
symbol = " "
python_binary = "python3"

[nodejs]
format = "via [ $version](bold green) "
disabled = true

[ruby]
format = "via [ $version]($style) "

[kubernetes]
format = 'via [ï´± $context\($namespace\)](bold purple) '
disabled = false

[kubernetes.context_aliases]
"do-fra1-prod-k8s-clcreative" = " lgcy-1"
"infra-home-kube-prod-1" = " prod-1"
"infra-home-kube-prod-2" = " prod-2"
"infra-cloud-kube-prod-1" = " prod-1"
"infra-cloud-kube-test-1" = " test-1"
STARSHIP_EOF

echo "Configuring bashrc..."
if ! grep -q "starship init bash" ~/.bashrc; then
    echo '' >> ~/.bashrc
    echo '# Initialize Starship prompt' >> ~/.bashrc
    echo 'eval "$(starship init bash)"' >> ~/.bashrc
fi

# Add to zshrc if it exists
if [ -f ~/.zshrc ]; then
    if ! grep -q "starship init zsh" ~/.zshrc; then
        echo '' >> ~/.zshrc
        echo '# Initialize Starship prompt' >> ~/.zshrc
        echo 'eval "$(starship init zsh)"' >> ~/.zshrc
    fi
fi

echo "Starship configured successfully for $(cat /etc/os-release | grep "^NAME=" | cut -d'"' -f2)!"
'@

$wslSetupScript | Set-Content "$env:TEMP\wsl-setup.sh" -Encoding UTF8

# Save Starship config script for manual setup
Write-Host "Starship setup will be done manually after WSL initialization." -ForegroundColor Green
Write-Host ""

Write-Host ""
Write-Host "=== Setup Complete! ===" -ForegroundColor Green
Write-Host ""
Write-Host "âœ“ Windows configuration done!" -ForegroundColor Green
Write-Host "âœ“ All applications installed" -ForegroundColor Green
Write-Host "âœ“ WSL2 enabled" -ForegroundColor Green
Write-Host "âœ“ WSL distributions installed with --no-launch (Ubuntu-22.04, kali-linux, arch-linux)" -ForegroundColor Green
Write-Host ""
Write-Host "=== NEXT STEPS ===" -ForegroundColor Yellow
Write-Host ""
Write-Host "1. RESTART YOUR COMPUTER (required for WSL2)" -ForegroundColor Cyan
Write-Host ""
Write-Host "2. After restart, launch each WSL distro from Windows Terminal:" -ForegroundColor Cyan
Write-Host "   - Open Windows Terminal" -ForegroundColor White
Write-Host "   - Type 'Ubuntu-22.04' and press Enter â†’ Create username/password" -ForegroundColor White
Write-Host "   - Type 'kali-linux' and press Enter â†’ Create username/password" -ForegroundColor White
Write-Host "   - Type 'arch-linux' and press Enter â†’ Create username/password" -ForegroundColor White
Write-Host ""
Write-Host "3. After initializing a distro, configure Starship with this command:" -ForegroundColor Cyan
Write-Host ""
Write-Host "   bash /mnt/c/Users/$env:USERNAME/Desktop/wsl-setup-starship.sh" -ForegroundColor Yellow
Write-Host ""
Write-Host "   Run this in each distro (Ubuntu, Kali, Arch) after creating your user" -ForegroundColor White
Write-Host ""
Write-Host "Already Configured:" -ForegroundColor Cyan
Write-Host "  âœ“ Windows Terminal with xcad theme" -ForegroundColor White
Write-Host "  âœ“ Hack Nerd Font" -ForegroundColor White
Write-Host "  âœ“ Dark mode" -ForegroundColor White
Write-Host "  âœ“ Clean taskbar (auto-hide, no search, no task view)" -ForegroundColor White
Write-Host "  âœ“ Mr. Robot wallpaper" -ForegroundColor White
Write-Host "  âœ“ Starship for PowerShell" -ForegroundColor White
Write-Host "  âœ“ Christian Lempa's tools (Git, Docker, kubectl, Terraform, etc.)" -ForegroundColor White
Write-Host ""
Write-Host "Starship setup script location: $setupScriptPath" -ForegroundColor Cyan
Write-Host ""